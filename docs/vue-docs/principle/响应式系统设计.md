# å“åº”å¼ç³»ç»Ÿè®¾è®¡
é˜…è¯»ä¼˜ç§€çš„æ¡†æ¶ä»£ç è®¾è®¡ï¼Œå¯ä»¥å­¦ä¹ ä½œè€…åœ¨è®¾è®¡ä»£ç ä¸Šçš„ä¼˜ç§€æ€è·¯ï¼Œäº†è§£ä½œè€…åœ¨å®ç°è‡ªå·±çš„æ€è·¯æ—¶è€ƒè™‘åˆ°çš„å„ç§æƒ…å†µï¼Œä»¥åŠå„ç§è§£å†³æ–¹æ¡ˆ...

vueä¸­çš„å“åº”å¼ç³»ç»Ÿè®¾è®¡æ˜¯vueæ¡†æ¶çš„æ ¸å¿ƒä¹‹ä¸€ï¼Œæ¥ä¸‹æ¥è¿™ç¯‡åˆ†äº«å¯ä»¥å¸®åŠ©å¤§å®¶ä»¿ç…§vueçš„å®ç°æ€è·¯å»è®¾è®¡ä¸€ä¸ªç®€å•çš„å“åº”å¼ç³»ç»Ÿ

## å“åº”å¼æ•°æ®ä¸å‰¯ä½œç”¨å‡½æ•°
å‰¯ä½œç”¨å‡½æ•°æŒ‡çš„æ˜¯ä¸€äº›ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š
```js
function effect(){
  document.body.innerText = 'hello vue3'
}
```
effectå‡½æ•°æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šè®¾ç½®bodyä¸‹çš„æ–‡æœ¬å†…å®¹ï¼Œå¦‚æœé™¤äº†effectå‡½æ•°ä¹‹å¤–ï¼Œå­˜åœ¨å…¶ä»–å‡½æ•°æ­£åœ¨è®¾ç½®æˆ–è€…è¯»å–æ–‡æœ¬å†…å®¹æ—¶ï¼Œeffectå‡½æ•°çš„æ‰§è¡Œå°±ç›´æ¥æˆ–é—´æ¥çš„å½±å“åˆ°äº†å…¶ä»–å‡½æ•°çš„æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯äº§ç”Ÿäº†å‰¯ä½œç”¨ï¼Œå‰¯ä½œç”¨å¾ˆå®¹æ˜“äº§ç”Ÿã€‚

ä¾‹å¦‚ä¿®æ”¹ä¸€ä¸ªå…¨å±€å˜é‡å°±æ˜¯å‰¯ä½œç”¨ï¼š
```js
let val = 1

function effect(){
  val = 2
}
```
ä»€ä¹ˆæ˜¯å“åº”å¼æ•°æ®ï¼Ÿå‰¯ä½œç”¨å‡½æ•°effectä¼šè®¾ç½®bodyä¸‹çš„æ–‡æœ¬å†…å®¹ï¼Œå…¶å€¼ä¸ºobj.textï¼Œå½“obj.textçš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¸Œæœ›effectä¼šé‡æ–°æ‰§è¡Œã€‚

```js
const obj = {text : 'hello world'}
function effect(){
  document.body.innerText = obj.text
}
```
ç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æœä¿®æ”¹objçš„textå­—æ®µï¼Œå‰¯ä½œç”¨å‡½æ•°è‡ªåŠ¨é‡æ–°æ‰§è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆæ•°æ®æºobjå°±å¯ä»¥è¢«ç§°ä¸ºæ˜¯å“åº”å¼æ•°æ®ã€‚ä½†é—æ†¾çš„æ˜¯ï¼Œç°åœ¨çš„æ•°æ®æºobjæ˜¯æ˜æ˜¾çš„â€œæ­»â€æ•°æ®ï¼Œä¸å…·æœ‰å“åº”æ€§ã€‚

## å“åº”å¼æ•°æ®çš„åŸºæœ¬å®ç°
å®ç°çš„åŸºæœ¬æ€è·¯åœ¨äºï¼š
- å½“å‰¯ä½œç”¨å‡½æ•° effect æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å­—æ®µçš„obj.textçš„**è¯»å–**æ“ä½œ
- å½“ä¿®æ”¹obj.textçš„å€¼æ—¶ï¼Œä¼šè§¦å‘å­—æ®µobj.textçš„**è®¾ç½®**æ“ä½œ

ä¸ºäº†ä½¿å¾—æ•°æ®å…·æœ‰å“åº”æ€§ï¼Œå°±ä¸å¾—ä¸å»ç›‘å¬æ•°æ®çš„â€œè¯»â€â€œå†™â€æ“ä½œï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œåœ¨Vue2ä¸­ï¼Œé‡‡ç”¨äº†`Object.defineProperty`å‡½æ•°æ¥å®ç°ï¼Œä½†åœ¨æœ€æ–°çš„Vue3ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»£ç†å¯¹è±¡`Proxy`æ¥å®ç°ï¼š

```js
// å­˜æ”¾å‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ
const bucket = new Set()

// æ•°æ®æº
const data = {text:'hello vue'}

// åˆ©ç”¨proxyå°†æ•°æ®è¿›è¡Œä»£ç†
const dataProxy = new Proxy(data,{
  // æ‹¦æˆªè¯»å–æ“ä½œ targetæŒ‡å‘æ•°æ®æº keyä¸ºæ•°æ®æºä¸Šçš„å±æ€§
  get(target, key){
    // å°†å‰¯ä½œç”¨å‡½æ•°æ”¾è¿›é›†åˆä¸­
    bucket.add(effect)
    return target[key]
  },
  // æ‹¦æˆªå†™æ“ä½œ newValä»£è¡¨æ›´æ”¹çš„æ–°å€¼
  set(target, key, newVal){
    // è®¾ç½®å±æ€§å€¼
    target[key] = newVal
    // å°†å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥è¿›è¡Œæ‰§è¡Œ
    bucket.forEach(fn => fn())
    // ä¿®æ”¹æˆåŠŸä¹‹åè¿”å›true
    return true
  }
})

// å‰¯ä½œç”¨å‡½æ•°
function effect(){
  document.body.innerText = dataProxy.text
}

// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
effect()

// 5ç§’åè‡ªåŠ¨ä¿®æ”¹
setTimeout(()=>{
  dataProxy.text = "hello reactive"
},5000)
```

## å¼€å§‹è®¾è®¡å“åº”å¼ç³»ç»Ÿ
åœ¨vueçš„çœŸå®å®ç°ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå‡½æ•°ç”¨äºä¸“é—¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°ï¼Œå“ªæ€•å‰¯ä½œç”¨å‡½æ•°æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¢«æ­£ç¡®çš„æ”¶é›†åˆ°é›†åˆä¸­

```js
// å…¨å±€å‰¯ä½œç”¨å‡½æ•°
let activeEffect

// å‰¯ä½œç”¨å‡½æ•°æ•è·å‡½æ•°
function effectRegister(fn){
  activeEffect = fn
  // æ‰§è¡Œåä¼šè§¦å‘ä¸€æ¬¡è¯»å–æ“ä½œ
  fn()
}
```
åœ¨ä¸Šè¿°ä»£ç ä¸­æœ‰ä¸€ä¸ªâ€œäº®ç‚¹â€ï¼Œä¹Ÿå°±æ˜¯åœ¨æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶,å‰¯ä½œç”¨å‡½æ•°åœ¨èµ‹å€¼ç»™å…¨å±€å˜é‡çš„åŒæ—¶ä¹Ÿè¢«è‡ªåŠ¨æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œè¿™æ¬¡æ‰§è¡Œè‡³å…³é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ä¹Ÿå°±æ„å‘³ç€æ•°æ®æºçš„è¯»å–æ“ä½œè¢«è§¦å‘äº†ï¼Œä¸€æ—¦è§¦å‘äº†è¯»å–æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»å…¨å±€å˜é‡activeEffectä¸­å–åˆ°å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä»è€Œè®°å½•åˆ°é›†åˆä¸­
:::tip
è¿™å°±æ˜¯æ€ä¹ˆå°†å‰¯ä½œç”¨å‡½æ•°è¿›è¡Œæ”¶é›†çš„ï¼
:::

ä¿®æ”¹ä¸€ä¸‹Proxyä¸­çš„é€»è¾‘:
```js
const dataProxy = new Proxy(data,{
  get(target, key){
    // å°†å‰¯ä½œç”¨å‡½æ•°æ”¾è¿›é›†åˆä¸­
    if(activeEffect) bucket.add(activeEffect)
    return target[key]
  },
  set(target, key, newVal){
    target[key] = newVal
    bucket.forEach(fn => fn())
    return true
  }
})
```
ä½†æ˜¯è¿™æ ·çš„è®¾è®¡ä¼šå­˜åœ¨ä¸€ä¸ªå°bugï¼Œå¦‚æœå‘æ•°æ®æºæ–°å¢ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§ï¼Œä¾ç„¶ä¼šå¯¼è‡´å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œ

```js
// å‰¯ä½œç”¨å‡½æ•°
function effect(){
  console.log('effectå‡½æ•°è§¦å‘')
  document.body.innerText = dataProxy.text
}

// æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
effectRegister(effect)

setTimeout(()=>{
  dataProxy.noExist = 'noExist'
},2000)
```
ä¸ºä»€ä¹ˆè¯´å¢åŠ ä¸€ä¸ªä¸å­˜åœ¨çš„å±æ€§å¯¼è‡´å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºç†è®ºä¸Šæ¥è¯´ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¸­**æ¶‰åŠ**åˆ°çš„å­—æ®µæ˜¯objçš„textå­—æ®µï¼Œæ­£ç¡®çš„é€»è¾‘æ˜¯textçš„å€¼æ”¹å˜ è§¦å‘ å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œ ï¼Œè€Œä¸æ˜¯å¢åŠ ä¸€ä¸ªå’Œå‰¯ä½œç”¨å‡½æ•°æ— å…³çš„å±æ€§ è§¦å‘ å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œã€‚

è¿™ä¸ªbugå­˜åœ¨çš„æ ¹æœ¬åŸå› åœ¨äºæ‰‹æœºå‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ`bucket`åªå’Œæ•°æ®æºäº§ç”Ÿäº†å…³ç³»ï¼Œ**å¿½ç•¥äº†æ²¡æœ‰åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸è¢«æ“ä½œçš„æ•°æ®æºç›®æ ‡å­—æ®µä¹‹é—´å»ºç«‹æ˜ç¡®çš„è”ç³»**ï¼Œè¦æ­£ç¡®çš„è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œï¼Œå’Œå¦‚ä¸‹çš„ä¸‰ä¸ªè§’è‰²å…³ç³»å¾ˆå¤§ï¼š
- è¢«æ“ä½œçš„ä»£ç†å¯¹è±¡ obj
- è¢«æ“ä½œçš„å­—æ®µå text
- å‰¯ä½œç”¨å‡½æ•° effectFn

é‚£ä¹ˆè¿™ä¸‰è€…çš„å…³ç³»å¯ä»¥è¯´æœ‰è¿™ä¹ˆå‡ ç§ï¼š

- å¤šä¸ªå‰¯ä½œç”¨å‡½æ•°è¯»å–åŒä¸€ä¸ªå¯¹è±¡çš„å­—æ®µ
```text
obj
 |___text
    	|___ effectFn1
      |___ effectFn2
      |___ ......
```

- ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°è¯»å–äº†åŒä¸€ä¸ªå¯¹è±¡çš„å¤šä¸ªå­—æ®µ
```text
obj
 |___text1
    	|___effectFn1

 |___text2
    	|___effectFn1

 |___ ......
```
- ä¸åŒå‰¯ä½œç”¨å‡½æ•°è¯»å–äº†ä¸åŒçš„å¯¹è±¡çš„å­—æ®µ
```text
obj
 |___text1
    	|___effectFn1

 |___text2
    	|___effectFn2

 |___ ......
```
æ€»ä½“æ¥è¯´ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æ„ï¼Œæ˜¾ç„¶éœ€è¦é‡æ–°è®¾è®¡æ”¶é›†å‰¯ä½œç”¨å‡½æ•°çš„å­˜å‚¨é›†åˆçš„æ•°æ®ç»“æ„ï¼š
```js
// å­˜æ”¾å‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ
const bucket = new WeakMap()

// åˆ©ç”¨proxyå°†æ•°æ®è¿›è¡Œä»£ç†
const dataProxy = new Proxy(data,{
  // æ‹¦æˆªè¯»å–æ“ä½œ targetæŒ‡å‘æ•°æ®æº keyä¸ºæ•°æ®æºä¸Šçš„å±æ€§
  get(target, key){
    // æ²¡æœ‰activeEffectï¼Œå°±ç›´æ¥returnå‡ºå»
    if(!activeEffect) return target[key]
    // æ ¹æ® target ä»é›†åˆä¸­å–å‡ºdepsMapï¼Œè¿™å°±æ˜¯ä¾èµ–depï¼Œå®ƒæ˜¯ key ---> effects
    let depsMap = bucket.get(target)
    // å¦‚æœä¸å­˜åœ¨ depsMap ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªMapä¸targetå…³è”
    if(!depsMap) bucket.set(target,(depsMap = new Map()))
    // è·å–å­—æ®µå¯¹åº”çš„ä¾èµ–åˆ—è¡¨
    let deps = depsMap.get(key)
    // å¦‚æœä¸å­˜åœ¨ä¾èµ–åˆ—è¡¨ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªSetä¸keyå…³è”
    if(!deps) depsMap.set(key,(deps = new Set()))
    // æ”¶é›†ä¾èµ–
    deps.add(activeEffect)
    return target[key]
  },
  // æ‹¦æˆªå†™æ“ä½œ newValä»£è¡¨æ›´æ”¹çš„æ–°å€¼
  set(target, key, newVal){
    // è®¾ç½®å±æ€§å€¼
    target[key] = newVal
    // å°†å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥è¿›è¡Œæ‰§è¡Œ
    const depsMap = bucket.get(target)
    if(!depsMap) return
    const deps = depsMap.get(key)
    deps && deps.forEach(fn => fn())
    // ä¿®æ”¹æˆåŠŸä¹‹åè¿”å›true
    return true
  }
})
```
è¿™æ¬¡è®¾è®¡å‡ºçš„æ•°æ®ç»“æ„ï¼Œåˆ†åˆ«ä½¿ç”¨äº†`WeakMap`ï¼Œ`Map`,`Set`

å¹¶ä¸”å¯ä»¥å¾—åˆ°è¿™ä¹ˆä¸€ä¸ªç»“æ„ï¼šWeakMapå­˜å‚¨çš„æ˜¯æ•°æ®æºå¯¹è±¡ï¼Œè€Œå¯¹åº”çš„å€¼æ˜¯ä¸€ä¸ªMapç»“æ„ï¼Œè€ŒMapç»“æ„ä¸­å­˜æ”¾çš„æ˜¯key--->depsçš„å…³ç³»ï¼ŒMapçš„é”®æ˜¯æ•°æ®æºå¯¹è±¡çš„keyï¼ŒMapçš„å€¼æ˜¯ä¸€ä¸ªè£…è½½å‰¯ä½œç”¨å‡½æ•°çš„Setã€‚å¦‚å›¾æ‰€ç¤ºï¼š

![image](./assets/weakmap-map-set.png)

è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„å“åº”å¼è®¾è®¡ç³»ç»Ÿï¼Œæœ€åå¯¹äºè¿™ä¸€å—çš„ä»£ç åšä¸€æ­¥å°è£…ï¼Œå°†åœ¨getæ‹¦æˆªå‡½æ•°é‡Œç¼–å†™çš„æŠŠå‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°ä¾èµ–é›†åˆçš„è¿™éƒ¨æ“ä½œå°è£…ä¸ºä¸€ä¸ª`track`è¡¨ç¤ºè¿½è¸ªï¼Œè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œçš„é€»è¾‘å°è£…åˆ°`trigger`ä¸­ï¼Œè¡¨ç¤ºè§¦å‘

æœ€åçš„ä»£ç è®¾è®¡å¦‚ä¸‹ğŸ‘‡ğŸ‘‡ğŸ‘‡

```js
// æ•°æ®æº
const data = {text:'hello vue'}

// å…¨å±€å‰¯ä½œç”¨å‡½æ•°
let activeEffect

// å‰¯ä½œç”¨å‡½æ•°æ•è·å‡½æ•°
function effectRegister(fn){
  activeEffect = fn
  // æ‰§è¡Œåä¼šè§¦å‘ä¸€æ¬¡è¯»å–æ“ä½œ
  fn()
}

// å­˜æ”¾å‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ
const bucket = new WeakMap()

// åˆ©ç”¨proxyå°†æ•°æ®è¿›è¡Œä»£ç†
const dataProxy = new Proxy(data,{
  // æ‹¦æˆªè¯»å–æ“ä½œ targetæŒ‡å‘æ•°æ®æº keyä¸ºæ•°æ®æºä¸Šçš„å±æ€§
  get(target, key){
    track(target, key)
    return target[key]
  },
  // æ‹¦æˆªå†™æ“ä½œ newValä»£è¡¨æ›´æ”¹çš„æ–°å€¼
  set(target, key, newVal){
    // è®¾ç½®å±æ€§å€¼
    target[key] = newVal
    trigger(target,key)
    // ä¿®æ”¹æˆåŠŸä¹‹åè¿”å›true
    return true
  }
})

// trackå‡½æ•°
function track(target, key){
      // æ²¡æœ‰activeEffectï¼Œå°±ç›´æ¥returnå‡ºå»
    if(!activeEffect) return 
    // æ ¹æ® target ä»é›†åˆä¸­å–å‡ºdepsMapï¼Œè¿™å°±æ˜¯ä¾èµ–depï¼Œå®ƒæ˜¯ key ---> effects
    let depsMap = bucket.get(target)
    // å¦‚æœä¸å­˜åœ¨ depsMap ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªMapä¸targetå…³è”
    if(!depsMap) bucket.set(target,(depsMap = new Map()))
    // è·å–å­—æ®µå¯¹åº”çš„ä¾èµ–åˆ—è¡¨
    let deps = depsMap.get(key)
    // å¦‚æœä¸å­˜åœ¨ä¾èµ–åˆ—è¡¨ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªSetä¸keyå…³è”
    if(!deps) depsMap.set(key,(deps = new Set()))
    // æ”¶é›†ä¾èµ–
    deps.add(activeEffect)
}

// triggerå‡½æ•°
function trigger(target,key){
      // å°†å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥è¿›è¡Œæ‰§è¡Œ
    const depsMap = bucket.get(target)
    if(!depsMap) return
    const deps = depsMap.get(key)
    deps && deps.forEach(fn => fn())
}

// å‰¯ä½œç”¨å‡½æ•°
function effect(){
  console.log('effectå‡½æ•°è§¦å‘')
  document.body.innerText = dataProxy.text
}

// æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
effectRegister(effect)

// 5ç§’åè‡ªåŠ¨ä¿®æ”¹
setTimeout(()=>{
  dataProxy.text = "hello reactive"
},5000)
```
## åˆ†æ”¯åˆ‡æ¢
```js
const data = { ok : true , text:'hello world'}
const obj = new Proxy( data , {/* ...... */})
effectRegister(() => {
  document.body.innerText = obj.ok ? obj.text : 'not'
})
```
åœ¨åŒ¿åå‡½æ•°å†…éƒ¨å­˜åœ¨ä¸€ä¸ªä¸‰å…ƒè¡¨è¾¾å¼ï¼Œæ ¹æ®å­—æ®µobj.okå€¼çš„ä¸åŒä¼šæ‰§è¡Œä¸åŒçš„ä»£ç åˆ†æ”¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œobj.okçš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä»£ç æ‰§è¡Œåˆ†æ”¯ä¹Ÿä¼šè·Ÿç€å˜åŒ–ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„åˆ†æ”¯åˆ‡æ¢ã€‚

è¿™ä¸ªåˆ†æ”¯åˆ‡æ¢å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œäº§ç”Ÿé—ç•™çš„å‰¯ä½œç”¨å‡½æ•°

æ ¹æ®ä¸Šæ–‡çš„æ¦‚è¿°ï¼Œè¿™ä¸ªåŒ¿åçš„å‰¯ä½œç”¨å‡½æ•°ç†åº”ä¼šè¢«`obj.ok`å’Œ`obj.text`å­—æ®µåŒæ—¶æ”¶é›†ï¼Œå‡è®¾ç°åœ¨obj.okçš„åˆæ—¶å€¼ä¸ºtrueï¼Œå½“å…¶å˜ä¸ºfalseæ—¶ï¼Œå¾ˆæ˜æ˜¾è¿™ä¸ªå‰¯ä½œç”¨å‡½æ•°å°±ä¼šè¢«è§¦å‘ï¼Œæ­¤æ—¶å¦‚æœ`obj.text`å€¼å‘ç”Ÿäº†100æ¬¡ä¸åŒçš„æ”¹å˜ï¼Œé‚£ä¹ˆå°±ä¼šé‡æ–°æ‰§è¡Œ100æ¬¡å‰¯ä½œç”¨å‡½æ•°ï¼Œä½†å®é™…ä¸Šï¼Œæ—¢ç„¶`obj.ok`éƒ½ä¸º`false`äº†ï¼Œä½•å¿…å»æ‰§è¡Œ100æ¬¡çš„å‰¯ä½œç”¨å‡½æ•°å‘¢ï¼Ÿè¿™å°±æ˜¯ç°åœ¨çš„è®¾è®¡æ‰€é—ç•™çš„å‰¯ä½œç”¨å‡½æ•°é—®é¢˜ã€‚

:::tip
å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œå…¶å®è§£å†³èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå¯ä»¥æŠŠå®ƒä»æ‰€æœ‰ä¸ä¹‹å…³è”çš„ä¾èµ–é›†åˆä¸­å»åšåˆ é™¤ã€‚**ç”±äºå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæœ¬èº«å°±ä¼šè§¦å‘æ•°æ®æºçš„å­—æ®µçš„`get`ï¼Œé‚£ä¹ˆåˆä¼šè¢«æ”¶é›†å›å»ï¼Œé‡æ–°å»ºç«‹è”ç³»ï¼Œå¥½å¤„åœ¨äºæ–°çš„è”ç³»ä¸ä¼šåŒ…å«é—ç•™çš„å‰¯ä½œç”¨å‡½æ•°**
:::

## cleanup
ä»ä¸Šæ–‡ä¸­çš„tipå¯ä»¥çŸ¥é“ï¼Œæ—¢ç„¶è¦çŸ¥é“å‰¯ä½œç”¨å‡½æ•°åœ¨å“ªæœ‰ä¾èµ–é›†åˆä¸­è¢«æ”¶é›†ï¼Œé‚£ä¹ˆå¯¹äºå‰¯ä½œç”¨å‡½æ•°æ¥è¯´ï¼Œå®ƒä¹Ÿåº”è¯¥æœ‰ä¸€ä¸ª`deps`å±æ€§ï¼Œç”¨æ¥å­˜å‚¨æ‰€æœ‰åŒ…å«å®ƒçš„ä¾èµ–é›†åˆ

å¯æƒ³è€ŒçŸ¥ï¼Œå½“å‰¯ä½œç”¨å‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå°±å¯ä»¥æŒ‚è½½ä¸€ä¸ªdeps
```js
// å‰¯ä½œç”¨å‡½æ•°æ•è·å‡½æ•°
function effectRegister(fn){
  //effectFnæ˜¯è¢«åŒ…è£…çš„å‰¯ä½œç”¨å‡½æ•°
  const effectFn = () => {
    activeEffect = effectFn
    // fnæ‰æ˜¯çœŸæ­£çš„å‰¯ä½œç”¨å‡½æ•°
    fn()
  }
  effectFn.deps = []
  // æ‰§è¡Œåä¼šè§¦å‘ä¸€æ¬¡è¯»å–æ“ä½œ
  effectFn()
}
```
ç„¶ååœ¨trackä¸­æ”¶é›†è¿™äº›deps
```js
function track(target, key){
    if(!activeEffect) return 
    let depsMap = bucket.get(target)
    if(!depsMap) bucket.set(target,(depsMap = new Map()))
    let deps = depsMap.get(key)
    if(!deps) depsMap.set(key,(deps = new Set()))
    deps.add(activeEffect)
    //æ–°å¢ï¼š ä¾èµ–æ”¶é›†deps
    activeEffect.deps.push(deps)
}
```
ç»è¿‡è¿™æ ·çš„`track`ä¹‹åï¼Œå°±å®Œæˆäº†äº’ç›¸çš„ä¾èµ–æ”¶é›†ï¼Œé‚£ä¹ˆå…³ç³»å›¾å˜ä¸ºäº†ä¸‹é¢è¿™æ ·ï¼š

![image](./assets/effectFn.png)

ç”±æ­¤cleanupå‡½æ•°è¯ç”Ÿäº†ï¼
```js
// å‰¯ä½œç”¨å‡½æ•°æ•è·å‡½æ•°
function effectRegister(fn){
  const effectFn = () => {
    // å› ä¸ºå‰¯ä½œç”¨å‡½æ•°è¢«triggeræ—¶ä¼šèµ°åˆ°è¿™é‡Œæ¥
    cleanup(effectFn)
    activeEffect = effectFn
    fn()
  }
  effectFn.deps = []
  effectFn()
}

function cleanup(effectFn){
  for(let i = 0 ; i < effectFn ; i++){
    let deps = effectFn.deps[i]
    deps.delete(effectFn)
  }
  // æ³¨æ„è¿™é‡Œéœ€è¦æ¸…æ‰ï¼Œé¿å…å†…å­˜æ³„æ¼
  effectFn.deps.length = 0
}
```
è¿™æ ·çœ‹èµ·æ¥ï¼Œè®¾è®¡çš„å“åº”å¼ç³»ç»Ÿä¼¼ä¹å¯ä»¥é¿å…å‰¯ä½œç”¨å‡½æ•°çš„é—ç•™äº§ç”Ÿäº†ã€‚ä½†åœ¨å®é™…çš„è¿è¡Œä¸­ï¼Œä¼šå‡ºç°æ— é™å¾ªç¯çš„é—®é¢˜,åŸå› æ˜¯å‘ç”Ÿåœ¨`trigger`å‡½æ•°ä¸­

```js
function trigger(target, key) {
  const depsMap = bucket.get(target);
  if (!depsMap) return;
  const effects = depsMap.get(key);
  effects && effects.forEach((fn) => fn());
  // åŸå› å°±åœ¨äº effects && effects.forEach(fn => fn())å½“ä¸­
  // åœ¨è¿™é‡Œéå† effects å‡½æ•°
  //æ‹¿å‡ºäº†å‰¯ä½œç”¨å‡½æ•°è¿›è¡Œæ‰§è¡ŒåŒ…è£…çš„effectFnï¼Œæ­¤æ—¶ä¼šç›´æ¥æ‰§è¡Œcleanup
  // ç´§æ¥ç€ï¼Œåˆé©¬ä¸Šè°ƒç”¨çœŸæ­£çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°åˆä¼šæŠŠå½“å‰æ–°çš„effectFnåˆåŠ å…¥åˆ°Setä¸­
  // ç”±æ­¤ï¼Œå½¢æˆäº†æ­»å¾ªç¯
}

// ç±»ä¼¼ä»£ç å¦‚ä¸‹
const set = new Set([1])
set.forEach(item => {
  set.delete(1)
  set.add(1)
  console.log('éå†ä¸­...')
})
```
æ€è€ƒé—®é¢˜å‘ç”Ÿçš„æœ¬è´¨åœ¨äºï¼Œå­˜æ”¾ä¾èµ–é›†åˆçš„set å’Œ è¿è¡Œä¾èµ–é›†åˆçš„set æ˜¯åŒä¸€ä¸ªsetï¼Œå¯¼è‡´å­˜åˆ åœ¨åŒä¸€ä¸ªsetä¸Šæ“ä½œä»è€Œå¼•å‘å¾ªç¯,å¥½çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ï¼Œå°†triggerä¸­å°† **å­˜æ”¾ä¾èµ–é›†åˆ** å’Œ **è¿è¡Œä¾èµ–é›†åˆéš”** ç¦»å¼€æ¥ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š
```js
function trigger(target,key){
    // å°†å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥è¿›è¡Œæ‰§è¡Œ
    const depsMap = bucket.get(target)
    if(!depsMap) return
    // å­˜å‚¨ä¾èµ–é›†åˆ
    const deps = depsMap.get(key)
    // è¿è¡Œä¾èµ–é›†åˆ
    const effectsToRun = new Set(deps)
    effectsToRun && effectsToRun.forEach(fn => fn())
}
```
**åˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¿™å°±å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„å“åº”å¼ç³»ç»Ÿï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š**
```js
// æ•°æ®æº
const data = {text:'hello vue'}

// å…¨å±€å‰¯ä½œç”¨å‡½æ•°
let activeEffect

// å‰¯ä½œç”¨å‡½æ•°æ•è·å‡½æ•°
function effectRegister(fn){
  const effectFn = () => {
    cleanup(effectFn)
    activeEffect = effectFn
    fn()
  }
  effectFn.deps = []
  // æ‰§è¡Œåä¼šè§¦å‘ä¸€æ¬¡è¯»å–æ“ä½œ
  effectFn()
}

// å­˜æ”¾å‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ
const bucket = new WeakMap()

// åˆ©ç”¨proxyå°†æ•°æ®è¿›è¡Œä»£ç†
const dataProxy = new Proxy(data,{
  // æ‹¦æˆªè¯»å–æ“ä½œ targetæŒ‡å‘æ•°æ®æº keyä¸ºæ•°æ®æºä¸Šçš„å±æ€§
  get(target, key){
    track(target, key)
    return target[key]
  },
  // æ‹¦æˆªå†™æ“ä½œ newValä»£è¡¨æ›´æ”¹çš„æ–°å€¼
  set(target, key, newVal){
    // è®¾ç½®å±æ€§å€¼
    target[key] = newVal
    trigger(target,key)
    // ä¿®æ”¹æˆåŠŸä¹‹åè¿”å›true
    return true
  }
})

// trackå‡½æ•°
function track(target, key){
      // æ²¡æœ‰activeEffectï¼Œå°±ç›´æ¥returnå‡ºå»
    if(!activeEffect) return 
    // æ ¹æ® target ä»é›†åˆä¸­å–å‡ºdepsMapï¼Œè¿™å°±æ˜¯ä¾èµ–depï¼Œå®ƒæ˜¯ key ---> effects
    let depsMap = bucket.get(target)
    // å¦‚æœä¸å­˜åœ¨ depsMap ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªMapä¸targetå…³è”
    if(!depsMap) bucket.set(target,(depsMap = new Map()))
    // è·å–å­—æ®µå¯¹åº”çš„ä¾èµ–åˆ—è¡¨
    let deps = depsMap.get(key)
    // å¦‚æœä¸å­˜åœ¨ä¾èµ–åˆ—è¡¨ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªSetä¸keyå…³è”
    if(!deps) depsMap.set(key,(deps = new Set()))
    // æ”¶é›†ä¾èµ–
    deps.add(activeEffect)
    // ä¾èµ–æ”¶é›†deps
    activeEffect.deps.push(deps)
}

// triggerå‡½æ•°
function trigger(target,key){
      // å°†å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥è¿›è¡Œæ‰§è¡Œ
    const depsMap = bucket.get(target)
    if(!depsMap) return
    // å­˜å‚¨ä¾èµ–é›†åˆ
    const deps = depsMap.get(key)
    // è¿è¡Œä¾èµ–é›†åˆ
    const effectsToRun = new Set(deps)
    effectsToRun && effectsToRun.forEach(fn => fn())
}

// cleanupå‡½æ•°
function cleanup(effectFn){
  for(let i = 0 ; i < effectFn ; i++){
    let deps = effectFn.deps[i]
    deps.delete(effectFn)
  }
  effectFn.deps.length = 0
}

// å‰¯ä½œç”¨å‡½æ•°
function effect(){
  console.log('effectå‡½æ•°è§¦å‘')
  document.body.innerText = dataProxy.text
}

// æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
effectRegister(effect)

// 5ç§’åè‡ªåŠ¨ä¿®æ”¹
setTimeout(()=>{
  dataProxy.text = "hello reactive"
},5000)
```

## åµŒå¥—çš„effectRegister
`effectRegister`åº”è¯¥æ˜¯è¢«è®¾è®¡æˆå¯ä»¥åµŒå¥—çš„ï¼Œè€Œä¸”è¿™æ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œå½¢å¼å¦‚ä¸‹ï¼š
```js
effectRegister(function effectFn1(){
  // ...
  effectRegister(function effectFn2(){
    // ...
  })
})
```
åœ¨Vueçš„å†…éƒ¨ä»£ç é‡Œï¼Œç»„ä»¶çš„æ¸²æŸ“å‡½æ•°å°±æ˜¯åœ¨ä¸€ä¸ª`effectRegister`ä¸­æ‰§è¡Œçš„ï¼Œå½“ç»„ä»¶`Foo`å†…éƒ¨æ¸²æŸ“äº†`Bar`ç»„ä»¶æ—¶ï¼Œå°±ä¼šå‘ç”ŸåµŒå¥—ï¼Œä»£ç å½¢å¼ç­‰åŒäº
```js
effectRegister(() => {
  Foo.render()
  effectRegister(() => {
    Bar.render()
  })
})
```
å¦‚æœä¸æ”¯æŒåµŒå¥—ï¼Œä¼šå¯¼è‡´ä¸€äº›é”™è¯¯å‘ç”Ÿï¼Œå‡å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­
```js
// æ•°æ®æº
const data = {
  foo: "hello world",
  bar: true,
};

// å°†åŒ¿åå‡½æ•°æ³¨å†Œä¸ºå‰¯ä½œç”¨å‡½æ•°
effectRegister(function effectFn1() {
  console.log("foo ç»„ä»¶è§¦å‘äº†");
  effectRegister(function effectFn2() {
    console.log("bar ç»„ä»¶è§¦å‘äº†");
    obj.bar;
  });
  obj.foo;
});

setTimeout(() => {
  obj.foo = 123;
  console.log("ä¿®æ”¹fooçš„å€¼....");
}, 2000);
```
ä¼šå‘ç°æ‰“å°çš„ç»“æœå˜æˆäº†...
```text
foo ç»„ä»¶è§¦å‘äº†
bar ç»„ä»¶è§¦å‘äº†
bar ç»„ä»¶è§¦å‘äº†
ä¿®æ”¹fooçš„å€¼....
```
`obj.foo`çš„å€¼æ”¹å˜æ²¡æœ‰è§¦å‘å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œåè€Œæ˜¯é”™è¯¯è§¦å‘äº†`obj.bar`å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°

é—®é¢˜å°±å‡ºåœ¨`effectRegister`å‡½æ•°èº«ä¸Šï¼Œå·²çŸ¥ `activeEffect` ä½œä¸ºå…¨å±€å˜é‡å»è®°å½•ä¸€ä¸ªæ­£åœ¨è¢«è®¿é—®å­—æ®µçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä¼šå¯¼è‡´åœ¨åµŒå¥—çš„`effectRegister`å‡½æ•°ä¸­ï¼Œå†…éƒ¨çš„å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œä¼šè¦†ç›–æ‰åŸå…ˆ`activeEffect`çš„å€¼ï¼Œå¹¶ä¸”æ°¸è¿œæ¢å¤ä¸äº†åŸæ¥çš„å€¼

é—®é¢˜å°±å‡ºåœ¨`effectRegister`å‡½æ•°èº«ä¸Šï¼Œå·²çŸ¥ `activeEffect` ä½œä¸ºå…¨å±€å˜é‡å»è®°å½•ä¸€ä¸ªæ­£åœ¨è¢«è®¿é—®å­—æ®µçš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä¼šå¯¼è‡´åœ¨åµŒå¥—çš„`effectRegister`å‡½æ•°ä¸­ï¼Œå†…éƒ¨çš„å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œä¼šè¦†ç›–æ‰åŸå…ˆ`activeEffect`çš„å€¼ï¼Œå¹¶ä¸”æ°¸è¿œæ¢å¤ä¸äº†åŸæ¥çš„å€¼

```js
effectRegister(function effectFn1() {
  console.log("foo ç»„ä»¶è§¦å‘äº†");
  // è¿™ä¸€æ­¥æ—¶ activeEffect è®°å½•çš„æ˜¯ effectFn1
  effectRegister(function effectFn2() {
    console.log("bar ç»„ä»¶è§¦å‘äº†");
    obj.bar;
    // è¿™ä¸€æ­¥æ—¶ activeEffectè®°å½•çš„æ˜¯ effectFn2
  });
  // é”™è¯¯å‘ç”Ÿäº†ï¼ï¼obj.fooå¯¹åº”å¾—effectFn1æ—©å·²è¢«è¦†ç›–ä¸ºeffectFn2
  // å¯¼è‡´obj.fooçš„å¯¹åº”å‰¯ä½œç”¨å‡½æ•°æ°¸è¿œåªèƒ½å˜ä¸ºeffectFn2
  obj.foo;
});
```
è§£å†³è¿™ä¸ªé—®é¢˜çš„åšæ³•æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°æ ˆeffectStackï¼Œå‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ—¶ï¼Œå°†å‰¯ä½œç”¨å‡½æ•°æ”¾å…¥æ ˆä¸­ï¼Œæ‰§è¡Œå®Œæ¯•æ—¶ï¼Œä»æ ˆä¸­å–å‡ºï¼Œå¹¶å§‹ç»ˆè®© activeEffect æŒ‡å‘æ ˆé¡¶
```js
// å‰¯ä½œç”¨å‡½æ•°æ ˆ
const effectStack = []

// æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°çš„å‡½æ•°
function makeEffect(fn) {
  const effectFn = () => {
    cleanup(effectFn);
    activeEffect = effectFn;
    effectStack.push(effectFn)
    fn();
    effectStack.pop()
    activeEffect = effectStack[effectStack.length - 1]
  };
  effectFn.deps = [];
  effectFn();
}
```
## é¿å…æ— é™é€’å½’
å¯èƒ½ä¼šæœ‰è¿™æ ·ä¸€ç§æƒ…å†µ
```js
effectRegister(() => {
  obj.num = obj.num + 1
})
```
ä¼šå¯¼è‡´çˆ†æ ˆï¼ŒåŸå› åœ¨äºï¼šå…ˆè¯»å–`obj.num`çš„å€¼ï¼Œç„¶åè§¦å‘ `track `æ“ä½œï¼Œå°†å½“å‰å‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°é›†åˆä¸­ï¼Œç„¶åç«‹å³ç»™ `obj.num` èµ‹å€¼ï¼Œè¿™æ—¶è§¦å‘ `trigger` æ“ä½œï¼ŒæŠŠé›†åˆä¸­çš„å‰¯ä½œç”¨å‡½æ•°å–å‡ºï¼Œç„¶ååˆè§¦å‘äº† `track` æ“ä½œ .... å‰¯ä½œç”¨å‡½æ•°æ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¿˜æ²¡æ‰§è¡Œå®Œæ¯•ï¼Œå°±åˆä¸å¾—ä¸å¼€å§‹ä¸‹ä¸€æ¬¡çš„æ‰§è¡Œï¼Œäº§ç”Ÿäº†æ— é™é€’å½’ï¼Œä»è€Œçˆ†æ ˆ

åˆ†æé—®é¢˜å¯ä»¥å‘ç°ï¼Œ`obj.num`çš„è¯»å–å’Œè®¾ç½®æ“ä½œæ˜¯åœ¨åŒä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°å†…è¿›è¡Œçš„ï¼Œæ­¤æ—¶`track`æ”¶é›†çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œè¿˜æ˜¯`trigger`è§¦å‘æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°éƒ½æ˜¯å…¨å±€å˜é‡`activeEffect`ã€‚éœ€è¦åšçš„æ˜¯ï¼Œåœ¨`trigger`åŠ¨ä½œå‘ç”Ÿæ—¶å¢åŠ å¿…è¦çš„å®ˆå«æ¡ä»¶ï¼šå¦‚æœ`trigger`è§¦å‘çš„æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°å’Œå½“å‰æ­£åœ¨æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•°ç›¸åŒï¼Œåˆ™ä¸è§¦å‘æ‰§è¡Œ

```js
function trigger(target, key) {
  const depsMap = bucket.get(target);
  if (!depsMap) return;
  
  // å­˜å‚¨ä¾èµ–ç»“åˆ
  const effects = depsMap.get(key);
  
  // è¿è¡Œä¾èµ–é›†åˆ
  const effectsToRun = new Set();
  
  effects && effects.forEach(effectFn => {
    // å¦‚æœå½“å‰æ‰§è¡Œçš„å‰¯ä½œç”¨å‡½æ•° ä¸ activeEffect ç›¸åŒï¼Œåˆ™ä¸åŠ å…¥åˆ°è¿è¡Œä¾èµ–é›†åˆ
    if(effectFn !== activeEffect){
      effectsToRun.add(effectFn)
    }
  })
  effectsToRun.forEach((effectFn) => effectFn());
}
```