# 图片体积优化
据统计，网页中加载的图片类资源，体积中位数是1009KB，请求数量中位数是21个。分别是页面总加载体积2419KB的41.7%，和总请求数量72个的29.5%。

肉眼可见图片是前端应用绝对的核心内容。

同时，前端应用的图片类资源也面临着很多痛点，主要是：
- 图片体积较大，加载耗时较大
- CDN流量开销比较高：图片资源数量多，体积大，是CDN费用的主要成本
前端应用中图片类资源的加载也直接影响了用户的体验，图片是首次内容绘制**FCP**和最大内容绘制**LCP**指标的测量要素，所以从图片类资源入手优化用户体验，对前端应用不可或缺

## 图片格式对比
浏览器平台支持众多的图片格式，分别有不同的特性，这里可以通过对比了解一下基本格式：

|格式|简介和特性|体积示例|浏览器兼容性|
|------|------|------|------|
|`jpg`|常见广泛的图片格式，体积一般|158KB|几乎所有浏览器都支持|
|`png`|带有透明通道，支持图片透明，体积较大|819KB|几乎所有浏览器都支持|
|`gif`|支持自动播放的动态图，体积较大|432KB|几乎所有浏览器都支持|
|`svg`|矢量图，任意缩放不影响清晰度，本质上是一种标记语言，可以被浏览器解析，视内容体积不定|---|Chrome4 以上版本支持|
|`webp`|支持动态图片，支持有损压缩和无损压缩，专注于web平台的表现，体积较小|136KB|Chrome32 以上版本支持|
|`avif`|支持动态图片，压缩率较高，体积较小|96KB|96KB	Chrome 85 以上版本支持|

从这个表格可以看出：
- **传统**图片格式：发明于前期的`jpg png gif svg`等
- **现代**图片格式：近十年发明的`webp avif`等

从发展来看：

- **体积**：传统格式显著大于现代图片格式。相较于`jpg`格式，`webp`格式图片一般能减少10%左右体积，`avif`格式更是能减少40%以上的文件体积
- **特性**：现代格式都能覆盖传统格式的动态图片，无损压缩等功能和特性，传统格式特性较为单一，现代格式支持动态图片，无损压缩等特性更多
- **浏览器兼容性**：兼容现代格式的浏览器占比比较少

:::tip
如果使用新型图片格式，虽然对前端应用图片资源体积大，加载耗时长，CDN开销较高的痛点会有明显优化。但是浏览器的兼容性确实不太放得开～
:::

## `<Picture>`元素
`<picture>`元素允许同时引入多个图片格式的子元素，并根据浏览器的兼容性，按先后顺序，自适应加载其中一个格式的图片，实现所有用户根据自身兼容性，获取到最优图片格式：

代码示例：
```html
<picture>
  <source type="image/avif" srcset="https://cdn.com/image.avif" />
  <source type="image/webp" srcset="https://cdn.com/image.webp" />
  <img src="https://cdn.com/image.jpg" alt="Example" />
</picture>
```
在这个例子中，`<picture>`元素中包含了2个`<source>`元素和1个`<img>`元素。

每个`<source>`元素都包含一个`srcset`属性，两处`srcset`属性分别用了`avif,webp`格式的图片URL，`type`属性则是格式对应的MIME类型

但是这段HTML只会触发`avif`一个图片的资源的下载

这是因为，对于`<picture>`元素，浏览器会按照**从上到下**的顺序检查`<source>`元素，**加载第一个浏览器兼容的格式**图片，并**忽略**后续的`<source>`元素和`img`元素。

如果浏览器对所有`<source>`声明的图片格式都不支持，那么它会降级到加载的`<img>`元素`src`属性对应`jpg`格式图片，作为兜底方案

:::tip
`<picture>`必须声明一个`img`子元素，否则如果只有`source`元素，浏览器不会加载`source`的`src`属性对应的图片资源
:::

也就是说，即使用户的浏览器既不支持解析`avif,webp`格式图片，甚至不兼容`<picture>`元素，浏览器也会**自动降级**到使用`<img>`元素，确保始终有正确的图片加载

`<picture>`元素目前经过业界的大量实践证明，可以用于生产环境

## 图片CDN
图片CDN就是CDN的扩展能力，专用于处理图片类型的各种资源。各大云服务供应商都有提供图片CDN服务，除基础的资源存储外，还附带了多种能力，例如：
- 格式转换，体积压缩
- 尺寸压缩
- 添加水印

而且这些能力使用起来非常简单，一般只需要更改一下图片的URL参数，就可以实现自动对图片应用相关处理
比如缩放图片：
|图片类型|体积|URL连接|
|------|------|------|
|原图|158kb|[simple-image](https://examples-1251000004.cos.ap-shanghai.myqcloud.com/sample.jpeg?imageMogr2/format/png)|
|宽高缩放为原图的50%|46.2kb|[sample.jpeg?imageMogr2/thumbnail/!50p](https://examples-1251000004.cos.ap-shanghai.myqcloud.com/sample.jpeg?imageMogr2/thumbnail/!50p)|
|宽高缩放为指定50*50像素|1.8kb|[sample.jpeg?imageMogr2/thumbnail/!50p](https://examples-1251000004.cos.ap-shanghai.myqcloud.com/sample.jpeg?imageMogr2/thumbnail/!50p)|

包括在NexSight中也有这样的处理：
:::tip
https://nexsight.cn-wlcb.ufileos.com/g%2F94ebbc586a42017d617abdb30b1eaa05.5848.png?UCloudPublicKey=TOKEN_1812343b-c098-47a6-b544-39d82a63a573&Expires=1711176494&Signature=l2PtW/Sw12hoxoFiFVqNjqRG45k=&iopcmd=convert&dst=webp&Q=70
:::

可以看到Q=70就相当于压缩质量为70%。

为了便于在前端项目中调用图片CDN的处理能力，还可以添加一套辅助函数，例如：
```js
// 预置一批可选格式值，例如缩放到75%，50%，25%
const ImgFormatOptions = {
  scaleTo75Percent: '!75p',
  scaleTo50Percent: '!50p',
  scaleTo25Percent: '!25p',
}

function getImgURL(name, options) {
  if (!name) {
    return ''
  }
  // 图片参数例子：?imageMogr2/thumbnail/!50p
  let url = `http://examples-1251000004.cos.ap-shanghai.myqcloud.com/${name}`
  if (!options) {
    return url
  }

  // 如果参数组合复杂，可以改为使用 URLSearchParams API
  // const searchParams = new URLSearchParams()
  // searchParams.set(option.key, option.value)
  //  return `${url}${searchParams.toString()}`

  let params = `?imageMogr2/`
  if (options.format) {
    params+=`format/${options.format}`
  } else if (options.thumbnail) {
    params+=`thumbnail/${options.thumbnail}`
  }
  // else if  ......

  return `${url}${params}`
}
```
基于这套辅助函数，就可以在前端的代码逻辑中，方便地使用图片CDN的各项能力，代码示例：
```js
// 1. 格式转换
getImgURL('sample.jpeg', {format: 'avif'}) 
// http://example.myqcloud.com/sample.jpeg?imageMogr2/format/avif

// 2. 裁剪缩略图
getImgURL('sample.jpeg', {thumbnail: ImgFormatOptions.scaleTo50Percent}) 
// http://example.myqcloud.com/sample.jpeg?imageMogr2/thumbnail/!50p
```
如果有条件的话，可以进一步和前端组件结合使用，封装出加载最优图片格式的`<PictureImage>`组件