# å“åº”å¼ç³»ç»Ÿè®¾è®¡
é˜…è¯»ä¼˜ç§€çš„æ¡†æž¶ä»£ç è®¾è®¡ï¼Œå¯ä»¥å­¦ä¹ ä½œè€…åœ¨è®¾è®¡ä»£ç ä¸Šçš„ä¼˜ç§€æ€è·¯ï¼Œäº†è§£ä½œè€…åœ¨å®žçŽ°è‡ªå·±çš„æ€è·¯æ—¶è€ƒè™‘åˆ°çš„å„ç§æƒ…å†µï¼Œä»¥åŠå„ç§è§£å†³æ–¹æ¡ˆ...

vueä¸­çš„å“åº”å¼ç³»ç»Ÿè®¾è®¡æ˜¯vueæ¡†æž¶çš„æ ¸å¿ƒä¹‹ä¸€ï¼ŒæŽ¥ä¸‹æ¥è¿™ç¯‡åˆ†äº«å¯ä»¥å¸®åŠ©å¤§å®¶ä»¿ç…§vueçš„å®žçŽ°æ€è·¯åŽ»è®¾è®¡ä¸€ä¸ªç®€å•çš„å“åº”å¼ç³»ç»Ÿ

## å“åº”å¼æ•°æ®ä¸Žå‰¯ä½œç”¨å‡½æ•°
å‰¯ä½œç”¨å‡½æ•°æŒ‡çš„æ˜¯ä¸€äº›ä¼šäº§ç”Ÿå‰¯ä½œç”¨çš„å‡½æ•°ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š
```js
function effect(){
  document.body.innerText = 'hello vue3'
}
```
effectå‡½æ•°æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šè®¾ç½®bodyä¸‹çš„æ–‡æœ¬å†…å®¹ï¼Œå¦‚æžœé™¤äº†effectå‡½æ•°ä¹‹å¤–ï¼Œå­˜åœ¨å…¶ä»–å‡½æ•°æ­£åœ¨è®¾ç½®æˆ–è€…è¯»å–æ–‡æœ¬å†…å®¹æ—¶ï¼Œeffectå‡½æ•°çš„æ‰§è¡Œå°±ç›´æŽ¥æˆ–é—´æŽ¥çš„å½±å“åˆ°äº†å…¶ä»–å‡½æ•°çš„æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯äº§ç”Ÿäº†å‰¯ä½œç”¨ï¼Œå‰¯ä½œç”¨å¾ˆå®¹æ˜“äº§ç”Ÿã€‚

ä¾‹å¦‚ä¿®æ”¹ä¸€ä¸ªå…¨å±€å˜é‡å°±æ˜¯å‰¯ä½œç”¨ï¼š
```js
let val = 1

function effect(){
  val = 2
}
```
ä»€ä¹ˆæ˜¯å“åº”å¼æ•°æ®ï¼Ÿå‰¯ä½œç”¨å‡½æ•°effectä¼šè®¾ç½®bodyä¸‹çš„æ–‡æœ¬å†…å®¹ï¼Œå…¶å€¼ä¸ºobj.textï¼Œå½“obj.textçš„å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¸Œæœ›effectä¼šé‡æ–°æ‰§è¡Œã€‚

```js
const obj = {text : 'hello world'}
function effect(){
  document.body.innerText = obj.text
}
```
ç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æžœä¿®æ”¹objçš„textå­—æ®µï¼Œå‰¯ä½œç”¨å‡½æ•°è‡ªåŠ¨é‡æ–°æ‰§è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆæ•°æ®æºobjå°±å¯ä»¥è¢«ç§°ä¸ºæ˜¯å“åº”å¼æ•°æ®ã€‚ä½†é—æ†¾çš„æ˜¯ï¼ŒçŽ°åœ¨çš„æ•°æ®æºobjæ˜¯æ˜Žæ˜¾çš„â€œæ­»â€æ•°æ®ï¼Œä¸å…·æœ‰å“åº”æ€§ã€‚

## å“åº”å¼æ•°æ®çš„åŸºæœ¬å®žçŽ°
å®žçŽ°çš„åŸºæœ¬æ€è·¯åœ¨äºŽï¼š
- å½“å‰¯ä½œç”¨å‡½æ•° effect æ‰§è¡Œæ—¶ï¼Œä¼šè§¦å‘å­—æ®µçš„obj.textçš„**è¯»å–**æ“ä½œ
- å½“ä¿®æ”¹obj.textçš„å€¼æ—¶ï¼Œä¼šè§¦å‘å­—æ®µobj.textçš„**è®¾ç½®**æ“ä½œ

ä¸ºäº†ä½¿å¾—æ•°æ®å…·æœ‰å“åº”æ€§ï¼Œå°±ä¸å¾—ä¸åŽ»ç›‘å¬æ•°æ®çš„â€œè¯»â€â€œå†™â€æ“ä½œï¼Œç„¶åŽæ‰§è¡Œå¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œåœ¨Vue2ä¸­ï¼Œé‡‡ç”¨äº†`Object.defineProperty`å‡½æ•°æ¥å®žçŽ°ï¼Œä½†åœ¨æœ€æ–°çš„Vue3ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ä»£ç†å¯¹è±¡`Proxy`æ¥å®žçŽ°ï¼š

```js
// å­˜æ”¾å‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ
const bucket = new Set()

// æ•°æ®æº
const data = {text:'hello vue'}

// åˆ©ç”¨proxyå°†æ•°æ®è¿›è¡Œä»£ç†
const dataProxy = new Proxy(data,{
  // æ‹¦æˆªè¯»å–æ“ä½œ targetæŒ‡å‘æ•°æ®æº keyä¸ºæ•°æ®æºä¸Šçš„å±žæ€§
  get(target, key){
    // å°†å‰¯ä½œç”¨å‡½æ•°æ”¾è¿›é›†åˆä¸­
    bucket.add(effect)
    return target[key]
  },
  // æ‹¦æˆªå†™æ“ä½œ newValä»£è¡¨æ›´æ”¹çš„æ–°å€¼
  set(target, key, newVal){
    // è®¾ç½®å±žæ€§å€¼
    target[key] = newVal
    // å°†å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥è¿›è¡Œæ‰§è¡Œ
    bucket.forEach(fn => fn())
    // ä¿®æ”¹æˆåŠŸä¹‹åŽè¿”å›žtrue
    return true
  }
})

// å‰¯ä½œç”¨å‡½æ•°
function effect(){
  document.body.innerText = dataProxy.text
}

// æ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°
effect()

// 5ç§’åŽè‡ªåŠ¨ä¿®æ”¹
setTimeout(()=>{
  dataProxy.text = "hello reactive"
},5000)
```

## å¼€å§‹è®¾è®¡å“åº”å¼ç³»ç»Ÿ
åœ¨vueçš„çœŸå®žå®žçŽ°ä¸­ï¼Œå­˜åœ¨ä¸€ä¸ªå‡½æ•°ç”¨äºŽä¸“é—¨æ¥æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°ï¼Œå“ªæ€•å‰¯ä½œç”¨å‡½æ•°æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œä¹Ÿå¯ä»¥è¢«æ­£ç¡®çš„æ”¶é›†åˆ°é›†åˆä¸­

```js
// å…¨å±€å‰¯ä½œç”¨å‡½æ•°
let activeEffect

// å‰¯ä½œç”¨å‡½æ•°æ•èŽ·å‡½æ•°
function effectRegister(fn){
  activeEffect = fn
  // æ‰§è¡ŒåŽä¼šè§¦å‘ä¸€æ¬¡è¯»å–æ“ä½œ
  fn()
}
```
åœ¨ä¸Šè¿°ä»£ç ä¸­æœ‰ä¸€ä¸ªâ€œäº®ç‚¹â€ï¼Œä¹Ÿå°±æ˜¯åœ¨æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°æ—¶,å‰¯ä½œç”¨å‡½æ•°åœ¨èµ‹å€¼ç»™å…¨å±€å˜é‡çš„åŒæ—¶ä¹Ÿè¢«è‡ªåŠ¨æ‰§è¡Œäº†ä¸€æ¬¡ï¼Œè¿™æ¬¡æ‰§è¡Œè‡³å…³é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œå‰¯ä½œç”¨å‡½æ•°ä¹Ÿå°±æ„å‘³ç€æ•°æ®æºçš„è¯»å–æ“ä½œè¢«è§¦å‘äº†ï¼Œä¸€æ—¦è§¦å‘äº†è¯»å–æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥ä»Žå…¨å±€å˜é‡activeEffectä¸­å–åˆ°å¯¹åº”çš„å‰¯ä½œç”¨å‡½æ•°ï¼Œä»Žè€Œè®°å½•åˆ°é›†åˆä¸­
:::tip
è¿™å°±æ˜¯æ€Žä¹ˆå°†å‰¯ä½œç”¨å‡½æ•°è¿›è¡Œæ”¶é›†çš„ï¼
:::

ä¿®æ”¹ä¸€ä¸‹Proxyä¸­çš„é€»è¾‘:
```js
const dataProxy = new Proxy(data,{
  get(target, key){
    // å°†å‰¯ä½œç”¨å‡½æ•°æ”¾è¿›é›†åˆä¸­
    if(activeEffect) bucket.add(activeEffect)
    return target[key]
  },
  set(target, key, newVal){
    target[key] = newVal
    bucket.forEach(fn => fn())
    return true
  }
})
```
ä½†æ˜¯è¿™æ ·çš„è®¾è®¡ä¼šå­˜åœ¨ä¸€ä¸ªå°bugï¼Œå¦‚æžœå‘æ•°æ®æºæ–°å¢žä¸€ä¸ªä¸å­˜åœ¨çš„å±žæ€§ï¼Œä¾ç„¶ä¼šå¯¼è‡´å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œ

```js
// å‰¯ä½œç”¨å‡½æ•°
function effect(){
  console.log('effectå‡½æ•°è§¦å‘')
  document.body.innerText = dataProxy.text
}

// æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
effectRegister(effect)

setTimeout(()=>{
  dataProxy.noExist = 'noExist'
},2000)
```
ä¸ºä»€ä¹ˆè¯´å¢žåŠ ä¸€ä¸ªä¸å­˜åœ¨çš„å±žæ€§å¯¼è‡´å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œæ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºç†è®ºä¸Šæ¥è¯´ï¼Œå‰¯ä½œç”¨å‡½æ•°ä¸­**æ¶‰åŠ**åˆ°çš„å­—æ®µæ˜¯objçš„textå­—æ®µï¼Œæ­£ç¡®çš„é€»è¾‘æ˜¯textçš„å€¼æ”¹å˜ è§¦å‘ å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œ ï¼Œè€Œä¸æ˜¯å¢žåŠ ä¸€ä¸ªå’Œå‰¯ä½œç”¨å‡½æ•°æ— å…³çš„å±žæ€§ è§¦å‘ å‰¯ä½œç”¨å‡½æ•°æ‰§è¡Œã€‚

è¿™ä¸ªbugå­˜åœ¨çš„æ ¹æœ¬åŽŸå› åœ¨äºŽæ‰‹æœºå‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ`bucket`åªå’Œæ•°æ®æºäº§ç”Ÿäº†å…³ç³»ï¼Œ**å¿½ç•¥äº†æ²¡æœ‰åœ¨å‰¯ä½œç”¨å‡½æ•°ä¸Žè¢«æ“ä½œçš„æ•°æ®æºç›®æ ‡å­—æ®µä¹‹é—´å»ºç«‹æ˜Žç¡®çš„è”ç³»**ï¼Œè¦æ­£ç¡®çš„è§¦å‘å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œï¼Œå’Œå¦‚ä¸‹çš„ä¸‰ä¸ªè§’è‰²å…³ç³»å¾ˆå¤§ï¼š
- è¢«æ“ä½œçš„ä»£ç†å¯¹è±¡ obj
- è¢«æ“ä½œçš„å­—æ®µå text
- å‰¯ä½œç”¨å‡½æ•° effectFn

é‚£ä¹ˆè¿™ä¸‰è€…çš„å…³ç³»å¯ä»¥è¯´æœ‰è¿™ä¹ˆå‡ ç§ï¼š

- å¤šä¸ªå‰¯ä½œç”¨å‡½æ•°è¯»å–åŒä¸€ä¸ªå¯¹è±¡çš„å­—æ®µ
```text
obj
 |___text
    	|___ effectFn1
      |___ effectFn2
      |___ ......
```

- ä¸€ä¸ªå‰¯ä½œç”¨å‡½æ•°è¯»å–äº†åŒä¸€ä¸ªå¯¹è±¡çš„å¤šä¸ªå­—æ®µ
```text
obj
 |___text1
    	|___effectFn1

 |___text2
    	|___effectFn1

 |___ ......
```
- ä¸åŒå‰¯ä½œç”¨å‡½æ•°è¯»å–äº†ä¸åŒçš„å¯¹è±¡çš„å­—æ®µ
```text
obj
 |___text1
    	|___effectFn1

 |___text2
    	|___effectFn2

 |___ ......
```
æ€»ä½“æ¥è¯´ï¼Œè¿™å…¶å®žæ˜¯ä¸€ä¸ªæ ‘å½¢ç»“æž„ï¼Œæ˜¾ç„¶éœ€è¦é‡æ–°è®¾è®¡æ”¶é›†å‰¯ä½œç”¨å‡½æ•°çš„å­˜å‚¨é›†åˆçš„æ•°æ®ç»“æž„ï¼š
```js
// å­˜æ”¾å‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ
const bucket = new WeakMap()

// åˆ©ç”¨proxyå°†æ•°æ®è¿›è¡Œä»£ç†
const dataProxy = new Proxy(data,{
  // æ‹¦æˆªè¯»å–æ“ä½œ targetæŒ‡å‘æ•°æ®æº keyä¸ºæ•°æ®æºä¸Šçš„å±žæ€§
  get(target, key){
    // æ²¡æœ‰activeEffectï¼Œå°±ç›´æŽ¥returnå‡ºåŽ»
    if(!activeEffect) return target[key]
    // æ ¹æ® target ä»Žé›†åˆä¸­å–å‡ºdepsMapï¼Œè¿™å°±æ˜¯ä¾èµ–depï¼Œå®ƒæ˜¯ key ---> effects
    let depsMap = bucket.get(target)
    // å¦‚æžœä¸å­˜åœ¨ depsMap ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªMapä¸Žtargetå…³è”
    if(!depsMap) bucket.set(target,(depsMap = new Map()))
    // èŽ·å–å­—æ®µå¯¹åº”çš„ä¾èµ–åˆ—è¡¨
    let deps = depsMap.get(key)
    // å¦‚æžœä¸å­˜åœ¨ä¾èµ–åˆ—è¡¨ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªSetä¸Žkeyå…³è”
    if(!deps) depsMap.set(key,(deps = new Set()))
    // æ”¶é›†ä¾èµ–
    deps.add(activeEffect)
    return target[key]
  },
  // æ‹¦æˆªå†™æ“ä½œ newValä»£è¡¨æ›´æ”¹çš„æ–°å€¼
  set(target, key, newVal){
    // è®¾ç½®å±žæ€§å€¼
    target[key] = newVal
    // å°†å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥è¿›è¡Œæ‰§è¡Œ
    const depsMap = bucket.get(target)
    if(!depsMap) return
    const deps = depsMap.get(key)
    deps && deps.forEach(fn => fn())
    // ä¿®æ”¹æˆåŠŸä¹‹åŽè¿”å›žtrue
    return true
  }
})
```
è¿™æ¬¡è®¾è®¡å‡ºçš„æ•°æ®ç»“æž„ï¼Œåˆ†åˆ«ä½¿ç”¨äº†`WeakMap`ï¼Œ`Map`,`Set`

å¹¶ä¸”å¯ä»¥å¾—åˆ°è¿™ä¹ˆä¸€ä¸ªç»“æž„ï¼šWeakMapå­˜å‚¨çš„æ˜¯æ•°æ®æºå¯¹è±¡ï¼Œè€Œå¯¹åº”çš„å€¼æ˜¯ä¸€ä¸ªMapç»“æž„ï¼Œè€ŒMapç»“æž„ä¸­å­˜æ”¾çš„æ˜¯key--->depsçš„å…³ç³»ï¼ŒMapçš„é”®æ˜¯æ•°æ®æºå¯¹è±¡çš„keyï¼ŒMapçš„å€¼æ˜¯ä¸€ä¸ªè£…è½½å‰¯ä½œç”¨å‡½æ•°çš„Setã€‚å¦‚å›¾æ‰€ç¤ºï¼š

![image](./assets/weakmap-map-set.png)

è¿™å°±æ˜¯ä¸€ä¸ªç®€å•çš„å“åº”å¼è®¾è®¡ç³»ç»Ÿï¼Œæœ€åŽå¯¹äºŽè¿™ä¸€å—çš„ä»£ç åšä¸€æ­¥å°è£…ï¼Œå°†åœ¨getæ‹¦æˆªå‡½æ•°é‡Œç¼–å†™çš„æŠŠå‰¯ä½œç”¨å‡½æ•°æ”¶é›†åˆ°ä¾èµ–é›†åˆçš„è¿™éƒ¨æ“ä½œå°è£…ä¸ºä¸€ä¸ª`track`è¡¨ç¤ºè¿½è¸ªï¼Œè§¦å‘å‰¯ä½œç”¨å‡½æ•°é‡æ–°æ‰§è¡Œçš„é€»è¾‘å°è£…åˆ°`trigger`ä¸­ï¼Œè¡¨ç¤ºè§¦å‘

æœ€åŽçš„ä»£ç è®¾è®¡å¦‚ä¸‹ðŸ‘‡ðŸ‘‡ðŸ‘‡

```js
// æ•°æ®æº
const data = {text:'hello vue'}

// å…¨å±€å‰¯ä½œç”¨å‡½æ•°
let activeEffect

// å‰¯ä½œç”¨å‡½æ•°æ•èŽ·å‡½æ•°
function effectRegister(fn){
  activeEffect = fn
  // æ‰§è¡ŒåŽä¼šè§¦å‘ä¸€æ¬¡è¯»å–æ“ä½œ
  fn()
}

// å­˜æ”¾å‰¯ä½œç”¨å‡½æ•°çš„é›†åˆ
const bucket = new WeakMap()

// åˆ©ç”¨proxyå°†æ•°æ®è¿›è¡Œä»£ç†
const dataProxy = new Proxy(data,{
  // æ‹¦æˆªè¯»å–æ“ä½œ targetæŒ‡å‘æ•°æ®æº keyä¸ºæ•°æ®æºä¸Šçš„å±žæ€§
  get(target, key){
    track(target, key)
    return target[key]
  },
  // æ‹¦æˆªå†™æ“ä½œ newValä»£è¡¨æ›´æ”¹çš„æ–°å€¼
  set(target, key, newVal){
    // è®¾ç½®å±žæ€§å€¼
    target[key] = newVal
    trigger(target,key)
    // ä¿®æ”¹æˆåŠŸä¹‹åŽè¿”å›žtrue
    return true
  }
})

// trackå‡½æ•°
function track(target, key){
      // æ²¡æœ‰activeEffectï¼Œå°±ç›´æŽ¥returnå‡ºåŽ»
    if(!activeEffect) return 
    // æ ¹æ® target ä»Žé›†åˆä¸­å–å‡ºdepsMapï¼Œè¿™å°±æ˜¯ä¾èµ–depï¼Œå®ƒæ˜¯ key ---> effects
    let depsMap = bucket.get(target)
    // å¦‚æžœä¸å­˜åœ¨ depsMap ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªMapä¸Žtargetå…³è”
    if(!depsMap) bucket.set(target,(depsMap = new Map()))
    // èŽ·å–å­—æ®µå¯¹åº”çš„ä¾èµ–åˆ—è¡¨
    let deps = depsMap.get(key)
    // å¦‚æžœä¸å­˜åœ¨ä¾èµ–åˆ—è¡¨ï¼Œé‚£ä¹ˆå°±æ–°å»ºä¸€ä¸ªSetä¸Žkeyå…³è”
    if(!deps) depsMap.set(key,(deps = new Set()))
    // æ”¶é›†ä¾èµ–
    deps.add(activeEffect)
}

// triggerå‡½æ•°
function trigger(target,key){
      // å°†å‰¯ä½œç”¨å‡½æ•°å–å‡ºæ¥è¿›è¡Œæ‰§è¡Œ
    const depsMap = bucket.get(target)
    if(!depsMap) return
    const deps = depsMap.get(key)
    deps && deps.forEach(fn => fn())
}

// å‰¯ä½œç”¨å‡½æ•°
function effect(){
  console.log('effectå‡½æ•°è§¦å‘')
  document.body.innerText = dataProxy.text
}

// æ³¨å†Œå‰¯ä½œç”¨å‡½æ•°
effectRegister(effect)

// 5ç§’åŽè‡ªåŠ¨ä¿®æ”¹
setTimeout(()=>{
  dataProxy.text = "hello reactive"
},5000)
```