# 事件循环
浏览器是一个多进程多线程的应用程序：**浏览器进程**，**网络进程**，**渲染进程** 等等。
![image](./assets/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%BF%9B%E7%A8%8B.png)
- 浏览器进程负责浏览器的页面展示，用户交互（click），子进程管理。浏览器内部会启动多个线程来处理不同的任务。
- 网络进程 负责加载网络资源。网络进程内部会启动多个线程来处理不同的网络任务
- **渲染进程**：渲染进程启动后，会开启一个渲染主线程，主线程负责执行HTML，CSS，JavaScript代码，每个标签页会开启一个新的渲染进程

## 渲染主线程如何工作
渲染主线程非常繁忙，它需要处理的任务包括但不限于：
- 解析HTML
- 解析CSS
- 计算样式
- 布局
- 处理图层
- 每秒把页面画60次
- 执行JS代码
- 执行事件处理函数
- 执行计时器的回调函数
- ......

对于浏览器来说：
- 代码执行好好的，此时用户点击了按钮，应该执行当前代码还是用户点击的代码？
- 代码执行好好的，一个计时任务到达了，应该执行当前代码还是执行计时任务代码？

需要去设计一个好的调度任务的机制，最经典的方式就是**消息队列：**
![image](./assets/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97.png)

- 在最开始时，渲染主线程会进行一个无限循环
- 每一次循环会检查消息队列是否有任务。如果有，取出来执行，执行之后再进入到下一次循环，否则进入休眠状态
- 其他所有线程（或者其他进程的线程）可以随时向消息队列的队尾添加任务。如果主线程是休眠的，那么唤醒主线程

**这么一个过程就可以被称之为事件循环**

## 什么是异步
代码执行过程中，会存在一些无法立即处理的任务，比如：
- 计时任务 — setTimeout，setInterval
- 网络通信 — XHR，fetch
- 用户操作后需要执行的任务 — addEventListener
如果让渲染主线程等待这些任务的时机达到，主线程上会长期处于**阻塞**的状态：
![image](./assets/%E5%90%8C%E6%AD%A5%E9%98%BB%E5%A1%9E.png)
**可以看到阻塞了太长时间，所以渲染主线程千万不能被阻塞，因为它承担了很多重要的任务**

**所以需要使用异步的方式，使得主线程永不阻塞：**

![image](./assets/%E5%BC%82%E6%AD%A5%E6%89%A7%E8%A1%8C.png)

## 任务存在优先级
其实任务没有优先级，毕竟都是进队列先进先出

但是消息队列是有优先级的
- 每个任务都有一个任务类型，同一个类型的任务必须在一个队列中，不同类型的任务可以分属于不同的队列。在一次事件循环中，浏览器可以根据实际情况从不同的队列中取出任务执行
- 浏览器必须准备好一个微队列，微队列的任务优先于其他任务的执行
:::tip
随着浏览器的复杂度提高，W3C不再使用宏队列这种说法
:::

在目前的 chrome 的实现中，包含了至少三种队列：
- 延时队列：用于存放计时器达到后的回调任务，优先级**中**
- 交互队列：存放用户操作后产生的事件处理任务，优先级**高**
- 微队列：放微任务，优先级**最高**