# é¡¶ç‚¹ç€è‰²å™¨
å¦‚æœæ”¶åˆ°è¿‡å·§å…‹åŠ›ğŸ«ç¤¼ç›’ï¼Œå¯ä»¥çŸ¥é“å·§å…‹åŠ›ç›’æœ‰å„ç§å„æ ·çš„å·§å…‹åŠ›ï¼Œå®ƒä»¬åœ¨é¢œè‰²ï¼Œå›¾æ¡ˆï¼Œå½¢çŠ¶ä¸Šéƒ½æœ‰æ‰€ä¸åŒï¼šæ—¢æœ‰ç™½è‰²çš„ï¼Œæ³¢çº¹çŠ¶çš„ï¼Œæ–¹å½¢çš„ï¼Œå’–å•¡è‰²çš„ï¼Œæ¡çº¹çŠ¶çš„ï¼Œåœ†å½¢çš„å·§å…‹åŠ›...

å¦‚æœè¯´ç‰‡å…ƒç€è‰²å™¨å†³å®šäº†ä¸€ä¸ªå·§å…‹åŠ›çš„é¢œè‰²å’Œå›¾æ¡ˆï¼Œé‚£ä¹ˆ**é¡¶ç‚¹ç€è‰²å™¨**å°±å†³å®šäº†å·§å…‹åŠ›çš„å½¢çŠ¶ã€‚

## 3Dä¸–ç•Œ
åœ¨å­¦ä¹ é¡¶ç‚¹ç€è‰²å™¨ä¹‹å‰ï¼Œéœ€è¦æŠŠ2dä¸–ç•Œè½¬æ¢ä¸º3dä¸–ç•Œã€‚

è¿™é‡Œè¦å¼•å…¥ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“[kokomi.js](https://github.com/alphardex/kokomi.js)ã€‚

è¿™é‡Œç®€å•çš„ä»‹ç»ä¸€ä¸‹å®ƒï¼š`kokomi.js`æ˜¯ä¸€ä¸ªåŸºäº[three.js](https://github.com/mrdoob/three.js)äºŒæ¬¡å°è£…çš„`3D`æ¡†æ¶ï¼Œé‡Œé¢å°è£…äº†å¾ˆå¤šå®ç”¨çš„å‡½æ•°å’Œç±»ï¼Œå¹¶ä¸”æ”¯æŒç»„ä»¶åŒ–åœ°ç¼–å†™`3D`ç‰©ä½“ï¼Œå¯ä»¥æŠŠå®ƒå½“ä½œæ˜¯`three.js`ç•Œçš„`jQuery`ï¼

æ¥ä¸‹æ¥ï¼Œå¯ä»¥ä½¿ç”¨`kokomi.js`æ¥æ­å»ºä¸€ä¸ª`3D`ä¸–ç•Œã€‚

æ–°å»ºä¸€ä¸ª`kokomi.html`æ–‡ä»¶ï¼Œé‡ç½®æµè§ˆå™¨èƒŒæ™¯è‰²ä¸ºé»‘è‰²
```css
    body{
        margin: 0;
        background: black;
    }
```
å®šä¹‰ç”»å¸ƒçš„å®¹å™¨æ ‡ç­¾ï¼Œè®¾ç½®`id`ä¸º`sketch`
```html
<div id="sketch"></div>
```
åŒæ—¶å¼•å…¥`kokomi.js`å’Œ`three.js`
```html
    <script src="https://unpkg.com/kokomi.js@1.9.78/build/kokomi.umd.js"></script>
    <script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
```
åˆ›å»ºä¸€ä¸ªç©ºç™½çš„`3d`ç”»å¸ƒ
```html
    <script>
        class Sketch extends kokomi.Base{
            create(){

            }
        }

        const sketch = new Sketch("#sketch");
        sketch.create()
    </script>
```
`Sketch`æ‰€ç»§æ‰¿çš„`kokomi.Base`ç±»ä¸ºå¼€å‘è€…è‡ªåŠ¨åˆ›å»ºäº†åœºæ™¯`scene`ï¼Œæ¸²æŸ“å™¨`renderer`ï¼Œç›¸æœº`camera`ï¼ŒåŠ¨ç”»å¾ªç¯ä»¥åŠå…¶ä»–çš„ä¸€äº›ç»„ä»¶ï¼Œç„¶ååœ¨`create`å‡½æ•°é‡Œç»§ç»­ç¼–å†™ä»£ç ã€‚

ç°åœ¨è®¾ç½®ä¸‹ç›¸æœºçš„åˆå§‹ä½ç½®ï¼Œå¹¶ä¸”å¼•å…¥è½¨é“æ§åˆ¶ç»„ä»¶`kokomi.OrbitControls`ï¼Œè¿™ä¸ªç»„ä»¶ä½¿å¼€å‘è€…èƒ½å¤Ÿé€šè¿‡æ‹–æ‹½é¼ æ ‡æ¥è‡ªç”±åœ°è§‚å¯Ÿæ•´ä¸ªåœºæ™¯ã€‚
```js
    this.camera.position.set(0,0,5);
    new kokomi.OrbitControls(this);
```
è¿™æ ·å°±æ­å»ºäº†ä¸€ä¸ªæœ€ç®€å•çš„`3d`ç”»å¸ƒï¼Œé‡Œé¢æš‚æ—¶ç©ºç©ºå¦‚ä¹Ÿã€‚

## ç½‘æ ¼
ç°åœ¨å¯ä»¥åˆ›å»ºç¬¬ä¸€ä¸ª`3d`ç‰©ä½“ï¼Œåœ¨`three.js`ä¸­ï¼Œ`3D`ç‰©ä½“è¢«ç§°ä½œç½‘æ ¼`Mesh`ï¼Œè€Œç½‘æ ¼æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼š
- å‡ ä½•ä½“`geometry`ï¼šå®šä¹‰äº†`3D`ç‰©ä½“çš„å½¢çŠ¶
- æè´¨`meterial`ï¼šå®šä¹‰äº†`3D`
ç°åœ¨å¯ä»¥è¯•ç€åˆ›å»ºä¸€ä¸ªç™½è‰²çš„çƒä½“ï¼š
```js
        class Sketch extends kokomi.Base{
            create(){
                this.camera.position.set(0,0,5);
                 new kokomi.OrbitControls(this);

                 const geomotry = new THREE.SphereGeometry(2,64,64);
                 const material = new THREE.MeshBasicMaterial({
                    color:"#ffffff",
                 })

                 const mesh = new THREE.Mesh(geomotry,material);
                 this.scene.add(mesh)
            }
        }

        const sketch = new Sketch("#sketch");
        sketch.create()
```
[SphereGeometry](https://threejs.org/docs/#api/en/geometries/SphereGeometry)æŒ‡å®šäº†å‡ ä½•ä½“ä¸ºçƒä½“ï¼ŒåŠå¾„ä¸º2ï¼Œå®½é«˜çš„ç»†åˆ†çš†ä¸º64ï¼›[MeshBasicMaterial](https://threejs.org/docs/#api/en/materials/MeshBasicMaterial)æŒ‡å®šäº†æè´¨ä¸ºåŸºç¡€æè´¨ï¼ˆæ²¡æœ‰å…‰ç…§ï¼Œåªæœ‰é¢œè‰²æˆ–çº¹ç†çš„æè´¨ï¼‰ï¼Œé¢œè‰²ä¸ºç™½è‰²ã€‚æ•ˆæœå¦‚ä¸‹ï¼š
![kokomi-ç™½çƒ](./assets/kokomi-ç™½çƒ.png)

å¯¹äº`three.js`ï¼Œå®ƒæ˜¯ä¸€ä¸ª`webGL`å°è£…ç¨‹åº¦éå¸¸é«˜çš„æ¡†æ¶ã€‚åˆšåˆšç”¨åˆ°çš„åŸºç¡€æè´¨ï¼ŒåŒ…æ‹¬`three.js`æ‰€æœ‰çš„å†…ç½®æè´¨éƒ½æ˜¯é€šè¿‡Shaderæ¥å®ç°çš„ã€‚

å°½ç®¡`three.js`å†…ç½®æè´¨æœ¬èº«éå¸¸å¥½ç”¨ï¼Œä½†æ˜¯ä¹Ÿæœ‰å±€é™æ€§çš„ï¼Œå¦‚æœæƒ³å®ç°ä¸€äº›è‡ªå®šä¹‰çš„æ•ˆæœï¼Œåªç”¨å†…ç½®æè´¨æ˜¯éš¾ä»¥å®ç°çš„ã€‚å®é™…ä¸Šï¼Œæœ‰ä¸€ç§æè´¨èƒ½å¤Ÿå®Œå®Œå…¨å…¨åœ°è‡ªå®šä¹‰Shaderã€‚

## è‡ªå®šä¹‰Shader
[ShaderMaterial](https://threejs.org/docs/#api/en/materials/ShaderMaterial)**æ»¡è¶³äº†å¼€å‘è€…èƒ½å¤Ÿè‡ªå®šä¹‰é¡¶ç‚¹ç€è‰²å™¨å’Œç‰‡å…ƒç€è‰²å™¨**ã€‚

å°†åˆšåˆšåœºæ™¯å†…çš„çƒä½“çš„æè´¨æ›¿æ¢ä¸º`ShaderMaterial`ã€‚
```js
const material = new THREE.ShaderMaterial()
```
å‘`THREE.ShaderMaterial`å†…ä¼ å…¥`glsl`ä»£ç :
```js
    const material = new THREE.ShaderMaterial(
        {
            vertexShader:`
                void main(){
                    vec4 modelPosition=modelMatrix*vec4(position,1.);
                    vec4 viewPosition=viewMatrix*modelPosition;
                    vec4 projectedPosition=projectionMatrix*viewPosition;
                    gl_Position=projectedPosition;
                }
            `,
            fragmentShader:`
                void main(){
                    vec3 color = vec3(1.,0.,0.);
                    gl_FragColor=vec4(color,1.);
                }
                `
        }
    )
```
æ•ˆæœå¦‚ä¸‹ï¼š
![è‡ªå®šä¹‰æè´¨](./assets/è‡ªå®šä¹‰æè´¨.png)
`fragmentShader`æ˜¯**ç‰‡å…ƒç€è‰²å™¨**ï¼Œé‡Œé¢çš„ä»£ç å°±æ˜¯ä¹‹å‰çš„Shaderä»£ç ã€‚ï¼ˆç•¥å¾®çš„å·®åˆ«æ˜¯`mainImage`å˜æˆäº†`main`ä¸”å‚æ•°æ¶ˆå¤±äº†ï¼Œ`fragColor`å˜æˆäº†`gl_FragColor`ã€‚ï¼‰

`vertexShader`æ˜¯**é¡¶ç‚¹ç€è‰²å™¨**ï¼Œå®ƒä»£è¡¨çš„æ„æ€æ˜¯ï¼šä¸€ä¸ªå«`position`çš„å˜é‡ï¼Œç»è¿‡äº†3ä¸ªçŸ©é˜µçš„å˜æ¢ï¼Œè¢«èµ‹ç»™äº†`gl_Position`ï¼Œè¿™ä¸‰ä¸ªçŸ©é˜µè¢«ç§°ä¸º`MVP`çŸ©é˜µï¼Œåˆ†åˆ«ä»£è¡¨äº†**æ¨¡å‹**ï¼Œ**è§†å›¾**ï¼Œ**æŠ•å½±**ã€‚

å…·ä½“å«ä¹‰å¯ä»¥å‚è€ƒ[ä»é›¶å¼€å§‹å­¦å›¾å½¢å­¦ï¼šMVP Transformation](https://zhuanlan.zhihu.com/p/343532009)

å…¶å®ï¼Œè¿™ä¸‰ä¸ªçŸ©é˜µçš„å…¶ä¸­2ä¸ªçŸ©é˜µï¼ˆæ¨¡å‹å’Œè§†å›¾ï¼‰å¯ä»¥åˆå¹¶ä¸ºä¸€ä¸ªçŸ©é˜µ`modelViewMatrix`ï¼Œè¿™æ ·å°±å¯ä»¥æŠŠé¡¶ç‚¹ç€è‰²å™¨çš„ä»£ç ç»™ç®€åŒ–ä¸ºä¸€è¡Œã€‚
```glsl
    void main(){
        gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);
    }
```
`MVP`çŸ©é˜µå˜æ¢è¿™ä¸ªæ“ä½œåŸºæœ¬éƒ½æ˜¯å›ºå®šçš„ï¼ŒçœŸæ­£éœ€è¦çš„å˜é‡æ˜¯`position`ï¼Œå¯¹å®ƒå¯ä»¥è¿›è¡Œå„ç§æ“ä½œï¼Œå°†å…¶å•ç‹¬ä½œä¸ºä¸€ä¸ªå˜é‡`p`æå–å‡ºæ¥ï¼š
```glsl
    void main(){
        vec3 p = position;
        gl_Position=projectionMatrix*modelViewMatrix*vec4(p,1.);
    }
```

## varying
åœ¨å‰æ–‡ä¸­ï¼Œç»å¸¸æåˆ°`UV`ï¼Œå…¶å®ï¼Œå®ƒå°±å­˜åœ¨äºé¡¶ç‚¹ç€è‰²å™¨ä¸­ï¼Œå˜é‡åä¸º`uv`ã€‚ç„¶è€Œå®ƒæ˜¯ä¸€ä¸ª`attribute`å˜é‡ï¼Œå¹¶ä¸æ˜¯`uniform`ï¼Œè¿™å°±æ„å‘³ç€å®ƒåªå­˜åœ¨äºé¡¶ç‚¹ç€è‰²å™¨ï¼Œè€Œä¸æ˜¯åœ¨ç‰‡å…ƒç€è‰²å™¨å†…ã€‚æ˜¯å¦å­˜åœ¨ä¸€äº›åŠæ³•å¯ä»¥å°†å®ƒä»ä¸€ä¸ªç€è‰²å™¨ä¼ é€’åˆ°å¦ä¸€ä¸ªç€è‰²å™¨ï¼Ÿ

åœ¨å‰æ–‡ä¸­ï¼Œæœ‰æåˆ°è¿‡â€œå˜é‡é™å®šç¬¦â€è¿™ä¸ªæ¦‚å¿µï¼Œè€Œå…¶ä¸­æœ‰ä¸€ç§èƒ½å¤Ÿåœ¨2ä¸ªç€è‰²å™¨ä¹‹é—´ä¼ é€’å˜é‡ï¼Œå®ƒå°±æ˜¯`varying`ã€‚

ç°åœ¨é¡¶ç‚¹ç€è‰²å™¨é¡¶éƒ¨å£°æ˜ä¸€ä¸ª`varying`å˜é‡`vUv`
```glsl
varying vec2 vUv;
```
åœ¨é¡¶ç‚¹ç€è‰²å™¨çš„`main`å‡½æ•°å†…éƒ¨çš„æœ«å°¾ï¼Œå°†å˜é‡`uv`èµ‹ç»™`vUv`
```glsl
void main(){
    ...
    vUv=uv
}
```
åœ¨ç‰‡å…ƒç€è‰²å™¨ä¸­çš„é¡¶éƒ¨ä¹Ÿå£°æ˜`vUv`
```glsl
varying vec2 vUv;
```
åœ¨ç‰‡å…ƒç€è‰²å™¨çš„`main`å‡½æ•°å†…ï¼Œå°†`vUv`èµ‹ç»™`uv`å˜é‡ï¼Œå¹¶ä¸”ç›´æ¥è¾“å‡ºé¢œè‰²
```glsl
void main(){
    vec2 uv = vUv;
    gl_FragColor = vec4(uv,0.,1.);
}
```